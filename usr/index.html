<!DOCTYPE html>
<html>
	<head>
		<meta charset = "utf-8">
		<title>페이스북 초성어 통계기</title>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<script src="http://code.jquery.com/color/jquery.color-2.1.0.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>

   		<link rel="stylesheet" type-"text/css" href="/style" />
  		
	</head>
	<body>
		<div id="fb-root"></div>
		<div id="bar"><a href="#"><strong>페이스북 초성어 통계기 beta</strong></a></div>
		
		<div id = "content">
			<div id="intro">
				<div style='font-style:italic; font-size:20px' class='bb'>어서오세요</div>
				<br>
				<div class='bb'>페이스북 초성어 통계기</div>는
				<br> <div id='userirm'>당신</div>의 담벼락 글을 분석해
				<br>초성어 및 기호 사용 통계를 내주는
				<br>아무짝에도 쓸모 없는 서비스입니다.
				<br><strong>※[베타 서비스] 기능 추가중.</strong>
			</div>
			<br>
			<div id='button'><a>시작하기</a></div>
			<div id='abox'></div>

		</div>
		<div id='like'><div class="fb-like" data-href="https://developers.facebook.com/docs/plugins/" data-width="400px" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div></div>


		<script>
			$(document).ready( function() {

				(function(d, s, id) {
				  var js, fjs = d.getElementsByTagName(s)[0];
				  if (d.getElementById(id)) return;
				  js = d.createElement(s); js.id = id;
				  js.src = "//connect.facebook.net/ko_KR/all.js#xfbml=1&appId=574466449298482";
				  fjs.parentNode.insertBefore(js, fjs);
				}(document, 'script', 'facebook-jssdk'));

				$('#button').click(function() {
					start();
				} );




				var chodb =
				[
					'ㅋ', 'ㅎ', 'ㅇ', 'ㄴ', 'ㄷ', 'ㄳ', 'ㅅㄱ', 'ㅈㅅ', 'ㅅㅂ', 'ㅄ', 'ㅈㄹ', '盧', '?', '!'	
				];
					//포함특수
					/* 	[
		'Fuck', 'Shit', '뻨', '쒵', '쓑', '쒯', '개새끼', '개시끼', '개세끼', '개색기', '개색끼', '개객끼', '개객기', '개같은', '개놈', '개년', '개자식', '씨발', '씨벌', '씨불', '씹할', '씨팔', '씨벨', '씨부랄', '씨부럴', '씨팔', '씨펄', 'ㅅㅂ', 'ㅆㅂ', '씹창', '씹년', '씹놈', '좆', '존나', 'ㅈㄴ', '미친놈', '미친년', '미친새끼', '엄창', '앰창', '니미', '병신', '븅신', '븅딱', '퓽신', '비융신', '피융신', 'ㅄ', 'ㅂㅅ', '지랄', '닥쳐', '盧?', '젠장', '빌어먹을', '빌어쳐먹을', '빌어처먹을', '제기랄'
	]; */
				var cho = new Array();
				for (index in chodb) {
					cho[index] = 0;
				}

				var yokpos;
				function search(string, pos, index) {
					if((yokpos = string.indexOf(chodb[index], pos)) != -1) {
						cho[index]++;
						console.log(chodb[index]+'검출로 '+cho[index]+'개');
						search(string, yokpos + index.length, index);
					}
				}
				function findyok(string) {
					for (index in chodb) {
						search(string, 0, index);
					}
				}

				//------------ 검출기 ----------------
				function start() {

					var socket = io.connect('http://yourfbwritingstylekr.herokuapp.com/');
	  				$.ajaxSetup({ cache: true });
	  				$.getScript("//connect.facebook.net/ko_KR/all.js", function(){
							
	  					console.log('스크립트 불러오기 완료');
	    				FB.init( {
	      					appId : '574466449298482',
							status : true,
							cookie : true,
							xfbml : false
	    				} );     
	    				console.log('페이스북 웹앱 인증 완료');

	    				FB.getLoginStatus( function(response) {
	    						
	    						function start2() {
	    							usrInfo();
									console.log('페이스북 담벼락 불러오기 시작...');
									readStream();
									$('#button').slideUp(500).children('a').css('display', 'none');
	    						}

								if (response.status === 'connected') {
									start2();

								} else if (response.status === 'not_authorized') {
									FB.login( function(response) { 
										if(response.authResponse) {
											start2();
										} else {
											console.log("Authorization Cancelled");
										}
									}, {scope: 'read_stream,publish_stream'}
									);
								} else {
									FB.login( function(response) { 
										if(response.authResponse) {
											console.log("Logged in");
										} else {
											console.log("Login Cancelled");
										}
									}, {scope: 'read_stream,publish_stream'}
									);
								}
								console.log("페이스북 계정 "+response.status);
							}  );

	  				}  );

					function usrInfo() {
	    				FB.api('/me', function(response) {
	      					console.log(response.name + '님 연동 완료');
	      					$('#userirm').html(response.name+'님').addClass('bb');
	   					});
	 				}
					
					function readStream() {
		 				
		 				function sendPosts(response) {
		   					console.log(response);
		   					for (element in response.data){
		   						post = response.data[element]
		   						if(post.message) {
									socket.emit('sendevent', { sending : post.message });
			 	   				}
							}

						}

	   					var getPosts = function (response){
							
							sendPosts(response);
				           	if(response.data.length!=0) {
				           		socket.emit('reqres'); console.log('cla reqres');
				           		nextPage = response.paging.next;
					         	$.getJSON(nextPage, function(json) {
					         		response = json;
					         		getPosts(response);
					         	});
				         	} else { socket.emit('reqres'); console.log('cla reqres'); }
		    			};
	 				
	 					FB.api('/me/feed', getPosts);

						socket.on('choanal', function (value) {
							cho = value.anal;
							console.log(cho);
							updateabox(cho);

	   					});
					} // readStream
					function updateabox(cho) {
						$('#abox').css('display', 'block').html('').stop().animate({'backgroundColor':'#55C'}, 250).animate({'backgroundColor':'#555'}, 250);
						for(index in cho) {
							if(cho[index]>0) 
								$('#abox').append('<div>'+chodb[index]+' : '+cho[index]+"회</div>");
						}
						$('.ani').slideDown(500, function() { $('.ani').removeClass('ani');} );
					}


				} // start

			}); // document ready
			
			</script>
		<fb:login-button show-faces="true" width="200" max-rows="1"></fb:login-button>
	</body>
</html>