<!DOCTYPE html>
<html>
	<head>
		<meta charset = "utf-8">
		<title>페이스북 초성어 통계기</title>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<script src="http://code.jquery.com/color/jquery.color-2.1.0.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="/timeago"></script>

   		<link rel="stylesheet" type-"text/css" href="/style" />
  		
	</head>
	<body>
		<div id="fb-root"></div>
		<div id="bar"><a href="#"><strong>페이스북 초성어 통계기 beta</strong></a></div>
		
		<div id = "content">
			<div id="intro">
				<div style='font-style:italic; font-size:20px' class='bb'>어서오세요</div>
				<br>
				<div class='bb'>페이스북 초성어 통계기</div>는
				<br> <div id='userirm'>당신</div>의 담벼락 글을 분석해
				<br>초성어 및 기호 사용 통계를 내주는
				<br>아무짝에도 쓸모 없는 서비스입니다.
				<br><strong>※[베타 서비스] 기능 추가중.</strong>
				<br><br>
				<div id='board'>
					<div id='since' class='bb'><time class='timeago'>지금</time></div>부터
					<br>총 <div id='cnt' class='bb'>0</div>개 글
					<br><div id='state'>통계 중...―</div>
				</div>
			</div>
			<br>
			<div class='button' id='startbutton'><a>시작하기</a></div>
			<div class='button' id='sharebutton'><a>공유하기</a></div>
			<div id='atext'></div>
			<div id='abox'></div>

		</div>
		<div id='like'><div class="fb-like" data-href="https://developers.facebook.com/docs/plugins/" data-width="400px" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div></div>


		<script>
			$(document).ready( function() {

				(function(d, s, id) {
				  var js, fjs = d.getElementsByTagName(s)[0];
				  if (d.getElementById(id)) return;
				  js = d.createElement(s); js.id = id;
				  js.src = "//connect.facebook.net/ko_KR/all.js#xfbml=1&appId=574466449298482";
				  fjs.parentNode.insertBefore(js, fjs);
				}(document, 'script', 'facebook-jssdk'));

				$('#startbutton').click(function() {
					start();
				} );




				var chodb =
				[
					'ㅋ', 'ㅎ', 'ㅇ', 'ㄴ', 'ㄷ', 'ㄳ', 'ㅅㄱ', 'ㅈㅅ', 'ㅅㅂ', 'ㅄ', 'ㅈㄹ', '盧', '?', '!'	
				];
					//포함특수
					/* 	[
		'Fuck', 'Shit', '뻨', '쒵', '쓑', '쒯', '개새끼', '개시끼', '개세끼', '개색기', '개색끼', '개객끼', '개객기', '개같은', '개놈', '개년', '개자식', '씨발', '씨벌', '씨불', '씹할', '씨팔', '씨벨', '씨부랄', '씨부럴', '씨팔', '씨펄', 'ㅅㅂ', 'ㅆㅂ', '씹창', '씹년', '씹놈', '좆', '존나', 'ㅈㄴ', '미친놈', '미친년', '미친새끼', '엄창', '앰창', '니미', '병신', '븅신', '븅딱', '퓽신', '비융신', '피융신', 'ㅄ', 'ㅂㅅ', '지랄', '닥쳐', '盧?', '젠장', '빌어먹을', '빌어쳐먹을', '빌어처먹을', '제기랄'
	]; */
				

				var yokpos;
				function search(string, pos, index) {
					if((yokpos = string.indexOf(chodb[index], pos)) != -1) {
						cho[index]++;
						console.log(chodb[index]+'검출로 '+cho[index]+'개');
						search(string, yokpos + index.length, index);
					}
				}
				function findyok(string) {
					for (index in chodb) {
						search(string, 0, index);
					}
				}

				var cnt = 0;
				var end = false;
				//------------ 검출기 ----------------
				function start() {

					var socket = io.connect('http://fbcho.herokuapp.com/');
	  				$.ajaxSetup({ cache: true });
	  				$.getScript("//connect.facebook.net/ko_KR/all.js", function(){
							
	  					console.log('스크립트 불러오기 완료');
	    				FB.init( {
	      					appId : '574466449298482',
							status : true,
							cookie : true,
							xfbml : false
	    				} );     
	    				console.log('페이스북 웹앱 인증 완료');

	    				FB.getLoginStatus( function(response) {
	    						
	    						function logMeIn()
								{
								  var paramsLocation=window.location.toString().indexOf('?');
								  var params="";
								  if (paramsLocation>=0)
								    params=window.location.toString().slice(paramsLocation);

								  top.location = 'https://graph.facebook.com/oauth/authorize?
								    client_id=574466449298482&scope=publish_stream&redirect_uri=https://fbcho.herokuapp.com'+params;
								}

	    						function start2() {
	    							usrInfo();
									console.log('페이스북 담벼락 불러오기 시작...');
									$('#atext').html('담벼락 불러오는 중').slideDown();
									readStream();
									$('#startbutton').slideUp(500).children('a').css('display', 'none');
									$('#board').css('display', 'block').children().css('display', 'inline');
	    						}

								if (response.status === 'connected') {
									start2();

								} else if (response.status === 'not_authorized') {
									
									logMeIn();
									/*
									FB.login( function(response) { 
										if(response.authResponse) {
											start2();
										} else {
											console.log("Authorization Cancelled");
										}
									}, {scope: 'read_stream,publish_stream'}
									);*/

								} else {
									logMeIn();
									/*
									FB.login( function(response) { 
										if(response.authResponse) {
											console.log("Logged in");
										} else {
											console.log("Login Cancelled");
										}
									}, {scope: 'read_stream,publish_stream'}
									);*/
								}
								console.log("페이스북 계정 "+response.status);
							}  );

	  				}  );

					function usrInfo() {
	    				FB.api('/me', function(response) {
	      					console.log(response.name + '님 연동 완료');
	      					$('#userirm').html(response.name+'님').addClass('bb').animate({'backgroundColor':'#77F'}, 500).animate({'backgroundColor':'transparent'}, 600);
	   					});
	 				}
					
					function readStream() {
		 				var cho = new Array();
						for (index in chodb) {
							cho[index] = 0;
						}
						var cho2;

		 				function sendPosts(response) {
		   					var tmpstring='';
		   					for (element in response.data) {
		   						if(response.data[element].message) {
		   							$('#atext').html(response.data[element].message);
			   						tmpstring += response.data[element].message;
			   					}
		   					}
		   					
		   					console.log('보냄');
							socket.emit('toserver', tmpstring);

						}

	   					var getPosts = function (response){
				           	if(response.data.length!=0) {
				           		sendPosts(response);

			           			$('#since').html('<time class="timeago">-</time>').children('time').attr('datetime', response.data[length-1].created_time).timeago().animate({'backgroundColor':'#77F'}, 300).animate({'backgroundColor':'transparent'}, 400);
								//시간처리
				           		cnt += response.data.length;
				           		$("#cnt").html(cnt).animate({'backgroundColor':'#77F'}, 300).animate({'backgroundColor':'transparent'}, 400);
				           		//카운트처리
								rotate();
								//통계중..
								nextPage = response.paging.next;
					         	$.getJSON(nextPage, function(json) {
					         		response = json;
					         		getPosts(response);
			         			});

			         			socket.emit('to2server');
			         			console.log('리턴요청');

				         	} else { 
				         		//---------통계 끝---------
				         		end = true; 
								rotate();
								$('#sharebutton').slideDown().animate({'backgroundColor':'#77F'}, 500).animate({'backgroundColor':'#449'}, 500).click( function() { share(); });
								$('#atext').html('담벼락 불러오기 끝!').delay(800).slideUp();
								var total=0;
								for (index in cho2) {
									total += cho2[index];
								}
								$('#abox').append('<br><div>총 '+total+'회</div>').children().last().addClass('bb');
							}
		    			};
	 				
	 					FB.api('/me/feed', getPosts);

						socket.on('toclient', function (data) {
							console.log('받음');
							cho = data.anal;
							chodb = data.anal2;
							cho2 = cho.slice(0);
							var chodb2 = chodb.slice(0);
							cho2.sort(function(a,b){return b-a});
							for(index in cho2) {
		   						 chodb2[index]= chodb[ cho.indexOf(cho2[index]) ];
		   						 cho[ cho.indexOf(cho2[index]) ]=null;
		   					}
							updateabox(cho2, chodb2);
	   					});
					} // readStream
					function share() {
						console.log('공유하기!');
						FB.ui( {
						  method: 'feed',
						  link: 'http://fbcho.herokuapp.com/',
						  caption: 'An example caption',
						}, function(response){} );
					}

					var rot = 0
					function rotate() {
						console.log(end);
						if (end==false) {
							switch(rot%3) {
								case 0 : {
									$('#state').html('통계 중...／');
									break;
								}
								case 1 : {
									$('#state').html('통계 중...―');
									break;
								}
								case 2 : {
									$('#state').html('통계 중...＼');
									break;
								}
							} rot++;
						} else $('#state').html('통계 완료').addClass('bb');
					}

					function updateabox(cho2, chodb2) {
						$('#abox').css('display', 'block').html('').animate({'backgroundColor':'#669'}, 100).animate({'backgroundColor':'#555'}, 100);
						for(index in cho2) {
							if(cho2[index]>0) 
								$('#abox').append('<div>'+chodb2[index]+' : '+cho2[index]+"회</div>");
						}
						$('.ani').slideDown(500, function() { $('.ani').removeClass('ani');} );
					}


				} // start

			}); // document ready
			
			</script>
		<fb:login-button show-faces="true" width="200" max-rows="1"></fb:login-button>
	</body>
</html>