<!DOCTYPE html>
<html>
	<head>
		<meta charset = "utf-8">
		<title>페이스북 욕설/초성어 통계기</title>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>

   		<!-- <link rel="href" stylesheet="style.css" /> -->
  		
	</head>
	<body>
		<div id="fb-root"></div>
		테스트3
		<br>
		<div id="userirm">이름</div>
		<div id="usergul">목록</div>
		<script>



			$(document).ready( function() {

				var yokdb =
				[
					'ㅋ', '?', '젠장'
					/*
					[
		'Fuck', 'Shit', '뻨', '쒵', '쓑', '쒯', '개새끼', '개시끼', '개세끼', '개색기', '개색끼', '개객끼', '개객기', '개같은', '개놈', '개년', '개자식', '씨발', '씨벌', '씨불', '씹할', '씨팔', '씨벨', '씨부랄', '씨부럴', '씨팔', '씨펄', 'ㅅㅂ', 'ㅆㅂ', '씹창', '씹년', '씹놈', '좆', '존나', 'ㅈㄴ', '미친놈', '미친년', '미친새끼', '엄창', '앰창', '니미', '병신', '븅신', '븅딱', '퓽신', '비융신', '피융신', 'ㅄ', 'ㅂㅅ', '지랄', '닥쳐', '盧?', '젠장', '빌어먹을', '빌어쳐먹을', '빌어처먹을', '제기랄'
	]; */
				];
				var yok = new Array();
				for (index in yokdb) {
					yok[index] = 0;
				}
				console.log(yokdb); console.log(yok);

				var yokpos;
				function search(string, pos, index) {
					if((yokpos = string.indexOf(yokdb[index], pos)) != -1) {
						yok[index]++;
						console.log(yokdb[index]+'검출로 '+yok[index]+'개');
						search(string, yokpos + index.length, index);
					}
				}
				function findyok(string) {
					for (index in yokdb) {
						search(string, 0, index);
					}
				}

				//------------ 검출기 ----------------

				var socket = io.connect('http://yourfbwritingstylekr.herokuapp.com/');
  				$.ajaxSetup({ cache: true });
  				$.getScript("//connect.facebook.net/ko_KR/all.js", function(){

  					console.log('getScript');
    				FB.init( {
      					appId : '574466449298482',
						status : true,
						cookie : true,
						xfbml : false
    				} );     

    				console.log('init');

    				FB.getLoginStatus( function(response) {
							if (response.status === 'connected') {
								testAPI();
								//console.log(yok);
								readStream();
								//console.log(yok);
							} else if (response.status === 'not_authorized') {
								FB.login( function(response) { 
									if(response.authResponse) {
										console.log("Authorized");
									} else {
										console.log("Authorization Cancelled");
									}
								}, {scope: 'read_stream,publish_stream'}
								);
							} else {
								FB.login( function(response) { 
									if(response.authResponse) {
										console.log("Logged in");
									} else {
										console.log("Login Cancelled");
									}
								}, {scope: 'read_stream,publish_stream'}
								);
							}

							console.log(response.status);
						}  );

  				}  );

				function testAPI() {
   					console.log('Welcome!  Fetching your information.... ');
    				FB.api('/me', function(response) {
      					console.log('Good to see you, ' + response.name + '.');
      					$('#userirm').html('Hello World, '+response.name);
   					});
 				}
				
				function readStream() {
	 				function printpost(response) {
	 					console.log(response);
			      	    for (element in response.data){
			         	   post = response.data[element]
			     	       if (post.message) {
								$('#usergul').append('<br>'+post.message);
							}  
			     	    }
	 				}
	 				function sendPosts(response) {
	   					
	   					for (element in response.data){
	   						post = response.data[element]
	   						if(post.message) {
								socket.emit('sendevent', { sending : post.message });
								//findyok(post.message);
								$('#usergul').append('<br>send ok');
		 	   				}
						}

					}

   					var getPosts = function (response){
						
						printpost(response);
						sendPosts(response);
			           	if(response.data.length!=0) {
			           		nextPage = response.paging.next;
				         	$.getJSON(nextPage, function(json) {
				         		response = json;
				         		getPosts(response);
				         	});
			         	} else socket.emit('reqres');
	    			};
 				
 					FB.api('/me/feed', getPosts);



					socket.on('yokanal', function (value) {
						$('#usergul').append('<br>received news!');
						var yok = value.anal;
						console.log(yok);

						//for(kind in yok) {
							//if(yok[kind]) 
						//	console.log(kind);
						//}
   					});
				}

			});
			
			</script>
		<fb:login-button show-faces="true" width="200" max-rows="1"></fb:login-button>
	</body>
</html>