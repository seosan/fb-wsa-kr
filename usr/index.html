<!DOCTYPE html>
<html>
	<head>
		<meta charset = "utf-8">
		<title>페이스북 초성어 통계기</title>
		<link rel="shortcut icon" href="/favicon">
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<script src="https://code.jquery.com/color/jquery.color-2.1.0.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="/timeago"></script>

   		<link rel="stylesheet" type-"text/css" href="/style" />
  		
	</head>
	<body>
		<div id="fb-root"></div>
		<div id="bar"><a href="#"><strong>페이스북 초성어 통계기 beta</strong></a></div>
		
		<div id = "content">
			<div id="intro">
				<div style='font-style:italic; font-size:20px;' class='bb'>어서오세요</div>
				<br>
				<div class='bb'>페이스북 초성어 통계기</div>는
				<br> <div id='userirm'>당신</div>의 스트림 포스팅을 분석해
				<br>초성어 뿐만 아니라 잡다한 사용 통계를 내주는
				<br>아무짝에도 쓸모 없는 서비스입니다.
				<br><strong>※[베타 서비스] 기능 추가중.</strong>
				<br><br>
				<div id='board'>
					<div id='since' class='bb'><time class='timeago'>지금</time></div>부터
					<br>총 <div id='cnt' class='bb'>0</div>개 글
					<br><div id='state'>통계 중...―</div>
				</div>
			</div>
			<br>
			<div class='button' id='startbutton'><a>시작하기</a></div>
			<div class='button' id='sharebutton'><a>공유하기</a></div>
			<div id='atext'></div>
			<div id='abox'></div>
			<div class="fb-like" data-href="http://fbcho.herokuapp.com" data-width="400px" data-layout="box_count" data-action="like" data-show-faces="false" data-share="true"></div>
		</div>
		
		<div id = 'footer'>건의사항은 1890mah@gmail.com / Copyright (c) 2014 choijiwon<br><br></div>

	</div>



		<script>
			/*
				S P A G H E T T I ! ! !
				Y E A P ! ! ! ! ! ! ! !
			*/

			$(document).ready( function() {

				(function(d, s, id) {
				  var js, fjs = d.getElementsByTagName(s)[0];
				  if (d.getElementById(id)) return;
				  js = d.createElement(s); js.id = id;
				  js.src = "https://connect.facebook.net/ko_KR/all.js#xfbml=1&appId=574466449298482";
				  fjs.parentNode.insertBefore(js, fjs);
				}(document, 'script', 'facebook-jssdk'));

				$('#startbutton').click(function() {
					start();
				} );


				var cnt = 0;
				var usrname;
				var total;
				var cho = new Array();
				for (index in chodb) {
					cho[index] = 0;
				}
				var cho2;
				var chodb =
				[
					'ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㅂ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅎ', 'ㄳ', 'ㅄ', 'ㅗ', 'ㅠ', '盧', '?', '!', ';', 'ㅡㅡ', '^^', '^~^', '^0^'
				];
				var chodb2;

				var end = false;
				//------------ 검출기 ----------------
				function start() {

					var socket = io.connect('https://fbcho.herokuapp.com/');
	  				$.ajaxSetup({ cache: true });
	  				$.getScript("//connect.facebook.net/ko_KR/all.js", function(){
							
	  					console.log('스크립트 불러오기 완료');
	    				FB.init( {
	      					appId : '574466449298482',
							status : true,
							cookie : true,
							xfbml : false
	    				} );     
	    				console.log('페이스북 웹앱 인증 완료');

	    				FB.getLoginStatus( function(response) {
	    						
	    						function logMeIn()
								{
									$('#intro').html('<div style="font-size:2em" class="bb">누구시죠?</div><br>페이스북 인증이 필요합니다.');
									setTimeout( function() {  
										window.location.href='https://graph.facebook.com/oauth/authorize?client_id=574466449298482&scope=publish_stream&redirect_uri=https://fbcho.herokuapp.com&scope=read_stream,publish_stream';
									}, 500);
								}

	    						function start2() {
	    							usrInfo();
									console.log('페이스북 담벼락 불러오기 시작...');
									$('#atext').html('담벼락 불러오는 중').slideDown();
									$('#abox').slideDown();
									readStream();
									$('#startbutton').slideUp(500);
									$('#board').css('display', 'block').children().css('display', 'inline');
	    						}

								if (response.status === 'connected') {
									start2();

								} else if (response.status === 'not_authorized') {
									
									logMeIn();
									/*
									FB.login( function(response) { 
										if(response.authResponse) {
											start2();
										} else {
											console.log("Authorization Cancelled");
										}
									}, {scope: 'read_stream,publish_stream'}
									);*/

								} else {
									logMeIn();
									/*
									FB.login( function(response) { 
										if(response.authResponse) {
											console.log("Logged in");
										} else {
											console.log("Login Cancelled");
										}
									}, {scope: 'read_stream,publish_stream'}
									);*/
								}
								console.log("페이스북 계정 "+response.status);
							}  );

	  				}  );

					function usrInfo() {
	    				FB.api('/me', function(response) {
	      					console.log(response.name + '님 연동 완료');
	      					usrname=response.name;
	      					$('#userirm').html(usrname+'님').addClass('bb').animate({'backgroundColor':'#77F'}, 500).animate({'backgroundColor':'transparent'}, 600);
	   					});
	 				}
					
					function readStream() {
		 				

		 				function sendPosts(response) {
		   					var tmpstring='';
		   					for (element in response.data) {
		   						if(response.data[element].message) {
		   							$('#atext').html(response.data[element].message);
			   						tmpstring += response.data[element].message;
			   					}
		   					}
		   					
		   					console.log('서버로 보냄');
							socket.emit('toserver', tmpstring);

						}

	   					var getPosts = function (response){
	   						console.log(response);
				           	if(response.data.length!=0) {
				           		sendPosts(response);
			           			$('#since').html('<time class="timeago">-</time>').children('time').attr('datetime', response.data[response.data.length-1].created_time).timeago().animate({'backgroundColor':'#77F'}, 300).animate({'backgroundColor':'transparent'}, 400);
								//시간처리
				           		cnt += response.data.length;
				           		$("#cnt").html(cnt).animate({'backgroundColor':'#77F'}, 300).animate({'backgroundColor':'transparent'}, 400);
				           		//카운트처리
								rotate();
								//통계중..
								nextPage = response.paging.next;
					         	$.getJSON(nextPage, function(json) {
					         		response = json;
					         		getPosts(response);
			         			});

			         			socket.emit('to2server');
			         			console.log('통계값 반환요청');

				         	} else { 
				         		//---------통계 끝---------
				         		end = true; 
								rotate();
								$('#sharebutton').slideDown().animate({'backgroundColor':'#77F'}, 500).animate({'backgroundColor':'#449'}, 500).click( function() { share(); });
								$('#atext').html('담벼락 불러오기 끝!').delay(2500).slideUp();
								
								total=0;
								for (index in cho2) {
									total += cho2[index];
								}

								$('#abox').append('<br><div class="total">총 '+total+'회</div>')
								$('.total').slideDown();
							}
		    			};
	 				
	 					FB.api('/me/feed', getPosts);

						socket.on('toclient', function (data) {
							console.log('받음');
							cho = data.anal;
							chodb = data.anal2;
							cho2 = cho.slice(0);
							chodb2 = chodb.slice(0);
							cho2.sort(function(a,b){return b-a});
							for(index in cho2) {
		   						 chodb2[index]= chodb[ cho.indexOf(cho2[index]) ];
		   						 cho[ cho.indexOf(cho2[index]) ]=null;
		   					}
							updateabox(cho2, chodb2);
	   					});
					} // readStream
					function share() {
						console.log('공유하기!');

						var posting = "☃ 페이스북 초성어 통계기!! ☃\n"+$('.timeago').html()+"부터 "+cnt+"개의 게시물을 올린 "+usrname+"님의 담벼락 통계\n";
						for(index in cho2) {
							if(cho2[index]>0)
								posting+='\n　'+chodb2[index]+' ----- '+cho2[index]+"번 사용";
						}
						posting+="\n\n총 "+total+"번의 초성어, 기호 등 사용";

						FB.api('/me/feed', 'post', { message: posting, picture:"https://fbcdn-photos-f-a.akamaihd.net/hphotos-ak-prn1/t39.2081/p128x128/851550_576267899118337_264509909_n.png",link:"https://fbcho.herokuapp.com", name:"페이스북 초성어 통계기", description:"당신의 페이스북 담벼락에 있는 글들을 모조리 훔쳐가서 샅샅이 파헤친 뒤 전혀 쓸모없는 정보 한 토막을 제공해 드립니다." }, function(response) {

							if (!response || response.error) {
								$('#atext').html('에러 발생!!! 아마도 인증 문제인듯.').slideDown();
								setTimeout( function() {  
									window.location.href='https://graph.facebook.com/oauth/authorize?client_id=574466449298482&scope=publish_stream&redirect_uri=https://fbcho.herokuapp.com&scope=read_stream,publish_stream';
								}, 500);
							} else {
								$('#state').html('공유 완료');
								$('#atext').html('공유 성공!').slideDown();
								$('#sharebutton').slideUp(500);
							}
						});



					}

					var rot = 0
					function rotate() {
						console.log(end);
						if (end==false) {
							switch(rot%3) {
								case 0 : {
									$('#state').html('통계 중...／');
									break;
								}
								case 1 : {
									$('#state').html('통계 중...―');
									break;
								}
								case 2 : {
									$('#state').html('통계 중...＼');
									break;
								}
							} rot++;
						} else $('#state').html('통계 완료').addClass('bb');
					}

					function updateabox(cho2, chodb2) {
						$('#abox').css('display', 'block').html('')
						for(index in cho2) {
							if(cho2[index]>0) 
								$('#abox').append('<div><span class="ct">'+chodb2[index]+'</span><span class="graph">'+cho2[index]+"</span></div>").children().last().children().last().css('width', cho2[index]*((cho2[0]<27)?10:(260/cho2[0])) );
						}
						$('.ani').slideDown(500, function() { $('.ani').removeClass('ani');} );
					}


				} // start

			}); // document ready
			
			</script>
		<fb:login-button show-faces="true" width="200" max-rows="1"></fb:login-button>
	</body>
</html>